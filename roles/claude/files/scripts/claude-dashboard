#!/usr/bin/env bash

# Claude Dashboard - fzf-based Claude session switcher with live preview
# Shows only tmux panes running Claude/OpenCode with pane-level status

# Guard: tmux must be running
tmux info &>/dev/null || exit 1

# Handle subcommands
case "$1" in
--join)
  exit 0
  ;;
--restore)
  exit 0
  ;;
esac

STATUS_DIR="$HOME/.cache/claude-status"
mkdir -p "$STATUS_DIR"

# Catppuccin Mocha Colors
YELLOW=$'\033[38;2;249;226;175m'
GREEN=$'\033[38;2;166;227;161m'
BLUE=$'\033[38;2;137;180;250m'
TEXT=$'\033[38;2;205;214;244m'
OVERLAY0=$'\033[38;2;108;112;134m'
RESET=$'\033[0m'

# Stale status cleanup: remove status files for panes that no longer exist
existing_panes=$(tmux list-panes -a -F '#{pane_id}' 2>/dev/null)
for status_file in "$STATUS_DIR"/pane_*.status; do
  [ -f "$status_file" ] || continue
  pane_num=$(basename "$status_file" .status)
  pane_num="${pane_num#pane_}"
  if ! echo "$existing_panes" | grep -q "^%${pane_num}$"; then
    rm -f "$status_file"
  fi
done

# PID tree walking detection (3 levels deep)
_check_pid_tree() {
  local pid="$1" depth="$2"
  [ "$depth" -le 0 ] && return 1
  for child in $(pgrep -P "$pid" 2>/dev/null); do
    local cmd
    cmd=$(ps -o comm= -p "$child" 2>/dev/null)
    [[ "$cmd" == "claude" || "$cmd" == "opencode" ]] && return 0
    _check_pid_tree "$child" $((depth - 1)) && return 0
  done
  return 1
}

has_claude_in_pane() {
  local pane_pid="$1"
  _check_pid_tree "$pane_pid" 3
}

# Pane enumeration - collect Claude panes
lines=()
while IFS='|' read -r pane_id pane_pid session_name window_index pane_index pane_path; do
  has_claude_in_pane "$pane_pid" || continue

  # Read status from pane status file
  pane_num="${pane_id#%}"
  status_file="$STATUS_DIR/pane_${pane_num}.status"
  if [ -f "$status_file" ]; then
    status=$(cat "$status_file" 2>/dev/null)
  else
    status=""
  fi

  # Format status display
  case "$status" in
  working)
    status_display="${YELLOW}working${RESET}"
    ;;
  idle)
    status_display="${GREEN}idle${RESET}"
    ;;
  *)
    status_display="${OVERLAY0}--${RESET}"
    ;;
  esac

  # Shorten path
  short_path="${pane_path/#$HOME/~}"

  display="  ${TEXT}${session_name}:${window_index}.${pane_index}${RESET}  ${BLUE}${short_path}${RESET}  ${status_display}"
  lines+=("${pane_id}|${display}")
done < <(tmux list-panes -a -F "#{pane_id}|#{pane_pid}|#{session_name}|#{window_index}|#{pane_index}|#{pane_current_path}")

# Edge case: no Claude panes found
if [ ${#lines[@]} -eq 0 ]; then
  echo "No active Claude Code sessions"
  sleep 1
  exit 0
fi

# Run fzf
printf '%s\n' "${lines[@]}" | fzf --ansi --no-sort --reverse \
  --delimiter '|' \
  --with-nth '2..' \
  --header "Claude Sessions  |  enter: switch  ctrl-j: join all  ctrl-r: restore" \
  --preview 'tmux capture-pane -ep -t {1} | tail -50' \
  --preview-window 'right:55%:wrap' \
  --bind 'enter:become(tmux switch-client -t {1})' \
  --bind 'ctrl-j:execute-silent(~/.claude/scripts/claude-dashboard --join)+abort' \
  --bind 'ctrl-r:execute-silent(~/.claude/scripts/claude-dashboard --restore)+abort' \
  --color "bg+:#313244,bg:#1e1e2e,spinner:#f5e0dc,hl:#f38ba8" \
  --color "fg:#cdd6f4,header:#f38ba8,info:#cba6f7,pointer:#f9e2af" \
  --color "marker:#a6e3a1,fg+:#cdd6f4,prompt:#cba6f7,hl+:#f38ba8"
