---

# Check for OS-specific configuration
- name: "{{ role_name }} | Checking for Distribution Config: {{ ansible_facts['distribution'] }}"
  ansible.builtin.stat:
    path: "{{ role_path }}/tasks/{{ ansible_facts['distribution'] }}.yml"
  register: distribution_config

- name: "{{ role_name }} | Run Tasks: {{ ansible_facts['distribution'] }}"
  ansible.builtin.include_tasks: "{{ ansible_facts['distribution'] }}.yml"
  when: distribution_config.stat.exists

# Common Claude configuration for all operating systems
- name: "{{ role_name }} | Ensure ~/.claude directory exists"
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.claude"
    state: directory
    mode: '0755'

- name: "{{ role_name }} | Check if settings.json exists and is not a symlink"
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.claude/settings.json"
  register: settings_file

- name: "{{ role_name }} | Remove existing settings.json if it's not a symlink"
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.claude/settings.json"
    state: absent
  when: settings_file.stat.exists and not settings_file.stat.islnk

- name: "{{ role_name }} | Create symlink to Claude settings.json"
  ansible.builtin.file:
    src: "{{ _files_path | default(role_path ~ '/files') }}/settings.json"
    dest: "{{ ansible_facts['env']['HOME'] }}/.claude/settings.json"
    state: link
    force: true

- name: "{{ role_name }} | Check if ~/.claude/scripts exists and is not a symlink"
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.claude/scripts"
  register: scripts_dir

- name: "{{ role_name }} | Remove existing scripts directory if it's not a symlink"
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.claude/scripts"
    state: absent
  when: scripts_dir.stat.exists and not scripts_dir.stat.islnk

- name: "{{ role_name }} | Create symlink to Claude scripts"
  ansible.builtin.file:
    src: "{{ _files_path | default(role_path ~ '/files') }}/scripts"
    dest: "{{ ansible_facts['env']['HOME'] }}/.claude/scripts"
    state: link
    force: true

- name: "{{ role_name }} | Check if ~/.claude/commands exists and is not a symlink"
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.claude/commands"
  register: commands_dir

- name: "{{ role_name }} | Remove existing commands directory if it's not a symlink"
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.claude/commands"
    state: absent
  when: commands_dir.stat.exists and not commands_dir.stat.islnk

- name: "{{ role_name }} | Create symlink to Claude commands"
  ansible.builtin.file:
    src: "{{ _files_path | default(role_path ~ '/files') }}/commands"
    dest: "{{ ansible_facts['env']['HOME'] }}/.claude/commands"
    state: link
    force: true

- name: "{{ role_name }} | Check if ~/.claude/hooks exists and is not a symlink"
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.claude/hooks"
  register: hooks_dir

- name: "{{ role_name }} | Remove existing hooks directory if it's not a symlink"
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.claude/hooks"
    state: absent
  when: hooks_dir.stat.exists and not hooks_dir.stat.islnk

- name: "{{ role_name }} | Create symlink to Claude hooks"
  ansible.builtin.file:
    src: "{{ _files_path | default(role_path ~ '/files') }}/hooks"
    dest: "{{ ansible_facts['env']['HOME'] }}/.claude/hooks"
    state: link
    force: true

- name: "{{ role_name }} | Check if ~/.claude/agents exists and is not a symlink"
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.claude/agents"
  register: agents_dir

- name: "{{ role_name }} | Remove existing agents directory if it's not a symlink"
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.claude/agents"
    state: absent
  when: agents_dir.stat.exists and not agents_dir.stat.islnk

- name: "{{ role_name }} | Create symlink to Claude agents"
  ansible.builtin.file:
    src: "{{ _files_path | default(role_path ~ '/files') }}/agents"
    dest: "{{ ansible_facts['env']['HOME'] }}/.claude/agents"
    state: link
    force: true

- name: "{{ role_name }} | Check if ~/.claude/skills exists and is not a symlink"
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.claude/skills"
  register: skills_dir

- name: "{{ role_name }} | Remove existing skills directory if it's not a symlink"
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.claude/skills"
    state: absent
  when: skills_dir.stat.exists and not skills_dir.stat.islnk

- name: "{{ role_name }} | Create symlink to Claude skills"
  ansible.builtin.file:
    src: "{{ _files_path | default(role_path ~ '/files') }}/skills"
    dest: "{{ ansible_facts['env']['HOME'] }}/.claude/skills"
    state: link
    force: true

- name: "{{ role_name }} | Check if .lsp.json exists and is not a symlink"
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.claude/.lsp.json"
  register: lsp_config_file

- name: "{{ role_name }} | Remove existing .lsp.json if it's not a symlink"
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.claude/.lsp.json"
    state: absent
  when: lsp_config_file.stat.exists and not lsp_config_file.stat.islnk

- name: "{{ role_name }} | Create symlink to Claude LSP configuration"
  ansible.builtin.file:
    src: "{{ _files_path | default(role_path ~ '/files') }}/.lsp.json"
    dest: "{{ ansible_facts['env']['HOME'] }}/.claude/.lsp.json"
    state: link
    force: true

# LSP Server Installation via Bun
- name: "{{ role_name }} | Check if bun is installed"
  ansible.builtin.command: which bun
  register: bun_check
  changed_when: false
  failed_when: false

- name: "{{ role_name }} | Install LSP servers via bun"
  ansible.builtin.command: "bun install -g {{ item }}"
  loop:
    - typescript
    - typescript-language-server
    - yaml-language-server
    - bash-language-server
    - pyright
  when: bun_check.rc == 0
  register: lsp_install
  changed_when: "'installed' in lsp_install.stdout"
  failed_when: false
