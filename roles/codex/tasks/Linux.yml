---
- name: "{{ role_name }} | Linux | Install | Check if codex is in PATH"
  ansible.builtin.command: which codex
  register: codex_path_check
  check_mode: false
  changed_when: false
  failed_when: false

- name: "{{ role_name }} | Linux | Install | Check local codex binary"
  ansible.builtin.stat:
    path: "{{ codex_install_path }}/codex"
  register: codex_local_binary

- name: "{{ role_name }} | Linux | Install | Detect managed codex version"
  ansible.builtin.command: "{{ codex_install_path }}/codex --version"
  register: codex_local_binary_version
  check_mode: false
  changed_when: false
  failed_when: false
  when: codex_local_binary.stat.exists

- name: "{{ role_name }} | Linux | Install | Detect codex version from PATH"
  ansible.builtin.command: codex --version
  register: codex_path_binary_version
  check_mode: false
  changed_when: false
  failed_when: false
  when:
    - not codex_local_binary.stat.exists
    - codex_path_check.rc == 0

- name: "{{ role_name }} | Linux | Install | Get latest Codex release"
  ansible.builtin.uri:
    url: "https://api.github.com/repos/openai/codex/releases/latest"
    headers:
      Accept: "application/vnd.github+json"
  register: codex_latest_release
  check_mode: false
  changed_when: false

- name: "{{ role_name }} | Linux | Install | Set version facts"
  ansible.builtin.set_fact:
    codex_release_tag: "{{ codex_latest_release.json.tag_name }}"
    codex_latest_version: >-
      {{
        codex_latest_release.json.tag_name
        | replace('rust-v', '')
        | regex_replace('^v', '')
      }}
    codex_installed_version_raw: >-
      {{
        codex_local_binary_version.stdout
        | default(codex_path_binary_version.stdout | default(''))
      }}
    codex_installed_version: >-
      {{
        (
          codex_local_binary_version.stdout
          | default(codex_path_binary_version.stdout | default(''))
          | split()
        )
        | last
        | default('')
      }}

- name: "{{ role_name }} | Linux | Install | Validate latest release version"
  ansible.builtin.fail:
    msg: >-
      Unable to parse Codex version from latest release tag:
      {{ codex_release_tag }}
  when: codex_latest_version == ""

- name: "{{ role_name }} | Linux | Install | Determine install requirement"
  ansible.builtin.set_fact:
    codex_install_required: >-
      {{
        (not codex_local_binary.stat.exists)
        or (codex_installed_version == '')
        or (codex_installed_version != codex_latest_version)
      }}

- name: "{{ role_name }} | Linux | Install | Ensure install directory exists"
  ansible.builtin.file:
    path: "{{ codex_install_path }}"
    state: directory
    mode: "0755"
  when: codex_install_required

- name: "{{ role_name }} | Linux | Install | Normalize architecture"
  ansible.builtin.set_fact:
    codex_linux_arch: >-
      {{
        codex_arch_map[ansible_facts['architecture']]
        | default('unsupported')
      }}
  vars:
    codex_arch_map:
      x86_64: x86_64
      amd64: x86_64
      aarch64: aarch64
      arm64: aarch64
  when: codex_install_required

- name: "{{ role_name }} | Linux | Install | Fail on unsupported architecture"
  ansible.builtin.fail:
    msg: >-
      Unsupported architecture for Codex Linux install:
      {{ ansible_facts['architecture'] }}
  when:
    - codex_install_required
    - codex_linux_arch == "unsupported"

- name: "{{ role_name }} | Linux | Install | Set download variables"
  ansible.builtin.set_fact:
    codex_archive_name: "codex-{{ codex_linux_arch }}-unknown-linux-musl.tar.gz"
    codex_extract_dir: "/tmp/codex-{{ ansible_facts['user_id'] }}"
  when: codex_install_required

- name: "{{ role_name }} | Linux | Install | Download and install binary"
  when:
    - codex_install_required
    - not ansible_check_mode
  block:
    - name: "{{ role_name }} | Linux | Install | Ensure temp extract dir"
      ansible.builtin.file:
        path: "{{ codex_extract_dir }}"
        state: directory
        mode: "0755"

    - name: "{{ role_name }} | Linux | Install | Download Codex archive"
      ansible.builtin.get_url:
        url: >-
          {{
            'https://github.com/openai/codex/releases/download/'
            ~ codex_release_tag ~ '/' ~ codex_archive_name
          }}
        dest: "/tmp/{{ codex_archive_name }}"
        mode: "0644"
        force: true

    - name: "{{ role_name }} | Linux | Install | Extract Codex archive"
      ansible.builtin.unarchive:
        src: "/tmp/{{ codex_archive_name }}"
        dest: "{{ codex_extract_dir }}"
        remote_src: true

    - name: "{{ role_name }} | Linux | Install | Install binary"
      ansible.builtin.copy:
        src: >-
          {{
            codex_extract_dir
            ~ '/codex-' ~ codex_linux_arch ~ '-unknown-linux-musl'
          }}
        dest: "{{ codex_install_path }}/codex"
        mode: "0755"
        remote_src: true

  always:
    - name: "{{ role_name }} | Linux | Install | Cleanup temporary files"
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "/tmp/{{ codex_archive_name }}"
        - "{{ codex_extract_dir }}"
      failed_when: false

- name: "{{ role_name }} | Linux | Install | Check mode summary"
  ansible.builtin.debug:
    msg: >-
      Codex install/upgrade required
      (installed={{ codex_installed_version | default('missing') }},
      latest={{ codex_latest_version }}).
      Skipping binary changes in check mode.
  when:
    - codex_install_required
    - ansible_check_mode

- name: "{{ role_name }} | Linux | Install | Verify codex installation"
  ansible.builtin.command: "{{ codex_install_path }}/codex --version"
  check_mode: false
  changed_when: false
  when:
    - codex_install_required
    - not ansible_check_mode

- name: "{{ role_name }} | Linux | Install | Verify existing managed install"
  ansible.builtin.command: "{{ codex_install_path }}/codex --version"
  check_mode: false
  changed_when: false
  when:
    - not codex_install_required
    - codex_local_binary.stat.exists

- name: "{{ role_name }} | Linux | Install | Verify existing install in PATH"
  ansible.builtin.command: codex --version
  check_mode: false
  changed_when: false
  when:
    - not codex_install_required
    - not codex_local_binary.stat.exists
    - codex_path_check.rc == 0
