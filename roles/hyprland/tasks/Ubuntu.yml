---
# Ubuntu-specific configuration tasks for Hyprland
# Installation is manual, configuration is automated

# ========================================
# CHECK IF HYPRLAND IS INSTALLED
# ========================================
- name: "{{ role_name }} | {{ ansible_distribution }} | Check if Hyprland is installed"
  ansible.builtin.stat:
    path: /usr/bin/Hyprland
  register: hyprland_binary

- name: "{{ role_name }} | {{ ansible_distribution }} | Hyprland not installed - manual installation required"
  when: not hyprland_binary.stat.exists
  block:
    - name: "{{ role_name }} | {{ ansible_distribution }} | Create installation script"
      ansible.builtin.copy:
        content: |
          #!/usr/bin/env bash
          # Hyprland Installation Script
          # Generated by dotfiles for Ubuntu {{ ansible_distribution_version }}

          set -euo pipefail

          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  Installing Hyprland via JaKooLit installer"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""

          # Create cache directory
          mkdir -p ~/.cache
          cd ~/.cache

          # Remove old installer if exists
          if [ -d "hyprland-installer" ]; then
              echo "Removing old installer directory..."
              # Some files may be owned by root, so use sudo if needed
              if ! rm -rf hyprland-installer 2>/dev/null; then
                  echo "Some files require sudo to remove..."
                  sudo rm -rf hyprland-installer
              fi
          fi

          # Clone installer (try version-specific branch first)
          echo "Cloning installer for Ubuntu {{ ansible_distribution_version }}..."
          if ! git clone --branch {{ ansible_distribution_version }} https://github.com/JaKooLit/Ubuntu-Hyprland.git hyprland-installer 2>/dev/null; then
              echo "Version-specific branch not found, using main branch..."
              git clone https://github.com/JaKooLit/Ubuntu-Hyprland.git hyprland-installer
          fi

          # Copy preset configuration
          echo "Copying preset configuration from dotfiles..."
          cp ~/.dotfiles/roles/hyprland/files/scripts/preset.conf ~/.cache/hyprland-installer/

          # Run installer
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  Starting JaKooLit installer"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "Preset configuration:"
          echo "  ✓ GTK themes and utilities"
          echo "  ✓ Bluetooth support"
          echo "  ✓ Thunar file manager"
          echo "  ✗ Zsh (managed by dotfiles)"
          echo "  ✗ SDDM (keeping existing login manager)"
          echo "  ✗ ROG utilities"
          echo "  ✗ Pokemon colorscripts"
          echo ""

          cd ~/.cache/hyprland-installer
          ./install.sh --preset preset.conf

          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "  Installation complete!"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "Next steps:"
          echo "  1. Run: dotfiles -t hyprland"
          echo "  2. Log out"
          echo "  3. Select 'Hyprland' at login screen"
          echo ""
        dest: /tmp/install-hyprland.sh
        mode: '0755'

    - name: "{{ role_name }} | {{ ansible_distribution }} | Display installation instructions"
      ansible.builtin.debug:
        msg:
          - ""
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - "  ⚠️  HYPRLAND NOT INSTALLED"
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - ""
          - "Installation script created at: /tmp/install-hyprland.sh"
          - ""
          - "To install Hyprland, run:"
          - "  /tmp/install-hyprland.sh"
          - ""
          - "After installation, run:"
          - "  dotfiles -t hyprland"
          - ""
          - "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          - ""

    - name: "{{ role_name }} | {{ ansible_distribution }} | Stop playbook - manual installation needed"
      ansible.builtin.fail:
        msg: "Run /tmp/install-hyprland.sh to install Hyprland, then run 'dotfiles -t hyprland' again."

# ========================================
# CONFIGURATION DEPLOYMENT
# (Only runs if Hyprland is installed)
# ========================================
- name: "{{ role_name }} | {{ ansible_distribution }} | Create config directories"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ ansible_user_dir }}/.config/hypr"
    - "{{ ansible_user_dir }}/.config/hypr/scripts"
    - "{{ ansible_user_dir }}/.config/waybar"
    - "{{ ansible_user_dir }}/.config/waybar/scripts"
  when: hyprland_binary.stat.exists

- name: "{{ role_name }} | {{ ansible_distribution }} | Symlink Hyprland configs"
  ansible.builtin.file:
    src: "{{ role_path }}/files/{{ item }}"
    dest: "{{ ansible_user_dir }}/.config/hypr/{{ item }}"
    state: link
    force: true
  loop:
    - hyprland.conf
    - hyprlock.conf
    - hypridle.conf
    - hyprpaper.conf
  when: hyprland_binary.stat.exists

- name: "{{ role_name }} | {{ ansible_distribution }} | Symlink Waybar config"
  ansible.builtin.file:
    src: "{{ role_path }}/files/waybar/config"
    dest: "{{ ansible_user_dir }}/.config/waybar/config"
    state: link
    force: true
  when: hyprland_binary.stat.exists

- name: "{{ role_name }} | {{ ansible_distribution }} | Symlink Waybar style"
  ansible.builtin.file:
    src: "{{ role_path }}/files/waybar/style.css"
    dest: "{{ ansible_user_dir }}/.config/waybar/style.css"
    state: link
    force: true
  when: hyprland_binary.stat.exists

- name: "{{ role_name }} | {{ ansible_distribution }} | Symlink Waybar scripts"
  ansible.builtin.file:
    src: "{{ role_path }}/files/waybar/scripts"
    dest: "{{ ansible_user_dir }}/.config/waybar/scripts"
    state: link
    force: true
  when: hyprland_binary.stat.exists

- name: "{{ role_name }} | {{ ansible_distribution }} | Symlink Hyprland scripts"
  ansible.builtin.file:
    src: "{{ role_path }}/files/scripts"
    dest: "{{ ansible_user_dir }}/.config/hypr/scripts"
    state: link
    force: true
  when: hyprland_binary.stat.exists

# ========================================
# CELL-BASED WINDOW MANAGEMENT SYSTEM
# ========================================
- name: "{{ role_name }} | {{ ansible_distribution }} | Create cells directories"
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ ansible_user_dir }}/.config/hypr/cells"
    - "{{ ansible_user_dir }}/.config/hypr/cells/layouts"
  when: hyprland_binary.stat.exists

- name: "{{ role_name }} | {{ ansible_distribution }} | Symlink cells directory"
  ansible.builtin.file:
    src: "{{ role_path }}/files/cells"
    dest: "{{ ansible_user_dir }}/.config/hypr/cells"
    state: link
    force: true
  when: hyprland_binary.stat.exists

- name: "{{ role_name }} | {{ ansible_distribution }} | Ensure cell scripts are executable"
  ansible.builtin.file:
    path: "{{ ansible_user_dir }}/.config/hypr/scripts/{{ item }}"
    mode: '0755'
  loop:
    - cell-manager.sh
    - cell-summon.sh
    - cell-overlay.sh
    - cell-reassign.sh
    - cell-generate-rules.sh
  when: hyprland_binary.stat.exists
  failed_when: false

- name: "{{ role_name }} | {{ ansible_distribution }} | Generate initial window rules"
  ansible.builtin.shell: |
    ~/.config/hypr/scripts/cell-generate-rules.sh
  args:
    creates: "{{ ansible_user_dir }}/.config/hypr/cells/window-rules.conf"
  when: hyprland_binary.stat.exists
  changed_when: true

# ========================================
# TERMINAL EMULATOR INTEGRATION
# ========================================
- name: "{{ role_name }} | {{ ansible_distribution }} | Add Wayland flags to Kitty config"
  ansible.builtin.lineinfile:
    path: "{{ ansible_user_dir }}/.config/kitty/kitty.conf"
    regexp: '^linux_display_server'
    line: 'linux_display_server wayland'
    create: false
  failed_when: false
  when: hyprland_binary.stat.exists

- name: "{{ role_name }} | {{ ansible_distribution }} | Add Wayland titlebar color to Kitty"
  ansible.builtin.lineinfile:
    path: "{{ ansible_user_dir }}/.config/kitty/kitty.conf"
    regexp: '^wayland_titlebar_color'
    line: 'wayland_titlebar_color background'
    create: false
  failed_when: false
  when: hyprland_binary.stat.exists

- name: "{{ role_name }} | {{ ansible_distribution }} | Add Wayland app-id to Ghostty config"
  ansible.builtin.lineinfile:
    path: "{{ ansible_user_dir }}/.config/ghostty/config"
    regexp: '^wayland-app-id'
    line: 'wayland-app-id = ghostty'
    create: false
  failed_when: false
  when: hyprland_binary.stat.exists

# ========================================
# FINAL STATUS MESSAGE
# ========================================
- name: "{{ role_name }} | {{ ansible_distribution }} | Configuration complete"
  ansible.builtin.debug:
    msg:
      - "✓ Hyprland configuration deployed"
      - "✓ Cell-based window management system installed"
      - "- Config directory: ~/.config/hypr"
      - "- Waybar config: ~/.config/waybar"
      - "- Cell system: ~/.config/hypr/cells"
      - "- Terminal configs updated for Wayland"
      - ""
      - "Next steps:"
      - "1. Log out of your current session"
      - "2. At login screen, select 'Hyprland' from session menu"
      - "3. Log in and enjoy!"
      - ""
      - "Keyboard shortcuts:"
      - "App Summons (F13 + key):"
      - "- F13+T: Terminal | F13+N: Notes | F13+O: 1Password"
      - "- F13+S: Spotify | F13+B: Browser | F13+G: Claude"
      - "Cell Management (F13 + key):"
      - "- F13+V: View cell layout | F13+R: Reassign window to cell"
      - "Window Management (Super):"
      - "- Super+H/J/K/L: Focus window | Super+Q: Close"
      - "- Super+1-9: Switch workspace"
  when: hyprland_binary.stat.exists
