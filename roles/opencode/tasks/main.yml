---
- name: "{{ role_name }} | Check if bun is installed"
  ansible.builtin.command: which bun
  register: bun_check
  failed_when: false
  changed_when: false

- name: "{{ role_name }} | Check if opencode is installed"
  ansible.builtin.command: which opencode
  register: opencode_check
  failed_when: false
  changed_when: false

- name: "{{ role_name }} | Install opencode via bun"
  ansible.builtin.command: bun install -g opencode-ai
  when:
    - bun_check.rc == 0
    - opencode_check.rc != 0
  register: opencode_install_result
  changed_when: "'installed' in opencode_install_result.stdout"

- name: "{{ role_name }} | Warn if bun is not installed"
  ansible.builtin.debug:
    msg: "WARNING: bun is not installed. Please run the bun role first or add it to default_roles before opencode."
  when: bun_check.rc != 0

# Configure opencode
- name: "{{ role_name }} | Ensure ~/.config/opencode directory exists"
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/opencode"
    state: directory
    mode: '0755'

- name: "{{ role_name }} | Check if opencode.json already exists"
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/opencode/opencode.json"
  register: opencode_config_file

- name: "{{ role_name }} | Backup existing opencode.json if it exists and is not a symlink"
  ansible.builtin.copy:
    src: "{{ ansible_facts['env']['HOME'] }}/.config/opencode/opencode.json"
    dest: "{{ ansible_facts['env']['HOME'] }}/.config/opencode/opencode.json.backup"
    remote_src: true
    mode: '0644'
  when: opencode_config_file.stat.exists and not opencode_config_file.stat.islnk

- name: "{{ role_name }} | Remove existing opencode.json if it's not a symlink"
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/opencode/opencode.json"
    state: absent
  when: opencode_config_file.stat.exists and not opencode_config_file.stat.islnk

- name: "{{ role_name }} | Create symlink to opencode.json"
  ansible.builtin.file:
    src: "{{ _files_path | default(role_path ~ '/files') }}/opencode.json"
    dest: "{{ ansible_facts['env']['HOME'] }}/.config/opencode/opencode.json"
    state: link
    force: true

- name: "{{ role_name }} | Check if ~/.config/opencode/scripts exists and is not a symlink"
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/opencode/scripts"
  register: scripts_dir

- name: "{{ role_name }} | Remove existing scripts directory if it's not a symlink"
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/opencode/scripts"
    state: absent
  when: scripts_dir.stat.exists and not scripts_dir.stat.islnk

- name: "{{ role_name }} | Create symlink to opencode scripts"
  ansible.builtin.file:
    src: "{{ _files_path | default(role_path ~ '/files') }}/scripts"
    dest: "{{ ansible_facts['env']['HOME'] }}/.config/opencode/scripts"
    state: link
    force: true

- name: "{{ role_name }} | Check if ~/.config/opencode/command exists and is not a symlink"
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/opencode/command"
  register: command_dir

- name: "{{ role_name }} | Remove existing command directory if it's not a symlink"
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/opencode/command"
    state: absent
  when: command_dir.stat.exists and not command_dir.stat.islnk

- name: "{{ role_name }} | Create symlink to opencode commands"
  ansible.builtin.file:
    src: "{{ _files_path | default(role_path ~ '/files') }}/command"
    dest: "{{ ansible_facts['env']['HOME'] }}/.config/opencode/command"
    state: link
    force: true

- name: "{{ role_name }} | Check if AGENTS.md already exists"
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/opencode/AGENTS.md"
  register: agents_file

- name: "{{ role_name }} | Backup existing AGENTS.md if it exists and is not a symlink"
  ansible.builtin.copy:
    src: "{{ ansible_facts['env']['HOME'] }}/.config/opencode/AGENTS.md"
    dest: "{{ ansible_facts['env']['HOME'] }}/.config/opencode/AGENTS.md.backup"
    remote_src: true
    mode: '0644'
  when: agents_file.stat.exists and not agents_file.stat.islnk

- name: "{{ role_name }} | Remove existing AGENTS.md if it's not a symlink"
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/opencode/AGENTS.md"
    state: absent
  when: agents_file.stat.exists and not agents_file.stat.islnk

- name: "{{ role_name }} | Create symlink to AGENTS.md"
  ansible.builtin.file:
    src: "{{ _files_path | default(role_path ~ '/files') }}/AGENTS.md"
    dest: "{{ ansible_facts['env']['HOME'] }}/.config/opencode/AGENTS.md"
    state: link
    force: true

- name: "{{ role_name }} | Install LSP servers via bun"
  ansible.builtin.command: "bun install -g {{ item }}"
  loop:
    - bash-language-server
    - yaml-language-server
    - typescript-language-server
    - typescript
    - "@ansible/ansible-language-server"
    - dockerfile-language-server-nodejs
  when: bun_check.rc == 0
  register: lsp_install
  changed_when: "'installed' in lsp_install.stdout"
  failed_when: false

- name: "{{ role_name }} | Check if go is installed"
  ansible.builtin.command: which go
  register: go_check
  failed_when: false
  changed_when: false

- name: "{{ role_name }} | Install helm-ls via go"
  ansible.builtin.command: go install github.com/mrjosh/helm-ls@latest
  when: go_check.rc == 0
  register: helm_ls_install
  changed_when: helm_ls_install.rc == 0
  failed_when: false

# oh-my-opencode plugin configuration
- name: "{{ role_name }} | Check if oh-my-opencode.json already exists"
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/opencode/oh-my-opencode.json"
  register: omo_config_file

- name: "{{ role_name }} | Backup existing oh-my-opencode.json if it exists and is not a symlink"
  ansible.builtin.copy:
    src: "{{ ansible_facts['env']['HOME'] }}/.config/opencode/oh-my-opencode.json"
    dest: "{{ ansible_facts['env']['HOME'] }}/.config/opencode/oh-my-opencode.json.backup"
    remote_src: true
    mode: '0644'
  when: omo_config_file.stat.exists and not omo_config_file.stat.islnk

- name: "{{ role_name }} | Remove existing oh-my-opencode.json if it's not a symlink"
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/opencode/oh-my-opencode.json"
    state: absent
  when: omo_config_file.stat.exists and not omo_config_file.stat.islnk

- name: "{{ role_name }} | Create symlink to oh-my-opencode.json"
  ansible.builtin.file:
    src: "{{ _files_path | default(role_path ~ '/files') }}/oh-my-opencode.json"
    dest: "{{ ansible_facts['env']['HOME'] }}/.config/opencode/oh-my-opencode.json"
    state: link
    force: true
